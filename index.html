<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e293b">
    <title>TB-CONTROL MAX</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-scroll { max-height: 90vh; overflow-y: auto; }
        .paciente-card { transition: all 0.2s ease; border-radius: 2rem; }
        .btn-floating { width: 5.5rem; height: 5.5rem; font-size: 3rem; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
        .alerta-card { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        /* Esconder app antes do login */
        #appContent { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">

    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl text-center">
            <div class="mb-8">
                <div class="bg-blue-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">üîê</div>
                <h2 class="font-black text-3xl text-slate-800 uppercase tracking-tighter">Acesso Restrito</h2>
                <p class="text-slate-400 font-bold text-xs uppercase mt-2 tracking-widest">Unidade Sanit√°ria de Vanduzi</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="userLogin" placeholder="UTILIZADOR" 
                    class="w-full border-4 border-slate-50 p-5 rounded-2xl bg-slate-50 outline-none font-black text-lg focus:border-blue-200 uppercase">
                
                <input type="password" id="passLogin" placeholder="PALAVRA-PASSE" 
                    class="w-full border-4 border-slate-50 p-5 rounded-2xl bg-slate-50 outline-none font-black text-lg focus:border-blue-200">
                
                <button onclick="validarAcesso()" 
                    class="w-full py-6 bg-blue-600 text-white rounded-2xl font-black text-xl uppercase shadow-xl active:scale-95 transition-all mt-4">
                    Entrar no Sistema
                </button>
            </div>
            <p id="loginErro" class="text-red-500 font-black text-xs mt-6 uppercase hidden italic">Credenciais Inv√°lidas!</p>
        </div>
    </div>

    <div id="appContent">
        <header class="bg-slate-900 p-8 text-white sticky top-0 z-10 shadow-2xl rounded-b-[3rem]">
            <div class="flex justify-between items-center mb-8">
                <h1 class="font-black text-3xl tracking-tighter italic text-blue-400">TB-CONTROL</h1>
                <div class="flex gap-4">
                    <button onclick="exportarDados()" class="bg-slate-800 p-4 rounded-2xl text-xl border border-slate-700">üì§</button>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-slate-800 p-4 rounded-2xl text-xl border border-slate-700">üì•</button>
                    <button onclick="logout()" class="bg-red-900/30 p-4 rounded-2xl text-xl border border-red-800/50">üö™</button>
                    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importarDados(event)">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-slate-800 p-5 rounded-[2rem] border-b-8 border-blue-500 text-center shadow-xl">
                    <p class="text-xs font-black text-blue-300 uppercase mb-2">Total</p>
                    <p id="dashTotal" class="text-4xl font-black">0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-[2rem] border-b-8 border-green-500 text-center shadow-xl">
                    <p class="text-xs font-black text-green-300 uppercase mb-2">Sens√≠vel</p>
                    <p id="dashSensivel" class="text-4xl font-black">0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-[2rem] border-b-8 border-red-500 text-center shadow-xl">
                    <p class="text-xs font-black text-red-300 uppercase mb-2">Resist.</p>
                    <p id="dashResistente" class="text-4xl font-black">0</p>
                </div>
            </div>
        </header>

        <main class="p-6 pb-32">
            <div id="painelAlertas" class="grid grid-cols-1 gap-4 mb-8"></div>
            <div class="relative mb-10">
                <input type="text" id="inputBusca" onkeyup="renderizar()" placeholder="PESQUISAR NOME OU NID..." 
                    class="w-full bg-white border-4 border-white p-7 pl-16 rounded-[2.5rem] shadow-xl outline-none focus:border-blue-500 text-xl font-bold transition-all">
                <span class="absolute left-6 top-7 text-3xl">üîç</span>
            </div>
            <h2 id="tituloLista" class="text-xs font-black text-slate-400 mb-4 ml-4 uppercase tracking-[0.3em]">Lista de Pacientes</h2>
            <div id="listaPacientes" class="space-y-6"></div>
        </main>

        <button onclick="abrirModal()" class="btn-floating fixed bottom-10 right-10 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center z-20 active:bg-blue-800 transition-all">+</button>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-xl rounded-[3.5rem] p-10 shadow-2xl modal-scroll border-t-[12px] border-blue-600">
            <div class="flex justify-between items-center mb-10 text-slate-800">
                <h2 class="font-black text-3xl uppercase tracking-tighter">Novo Cadastro</h2>
                <button onclick="fecharModal()" class="text-4xl text-slate-300">‚úï</button>
            </div>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="nid" placeholder="NID" class="w-full border-4 border-slate-50 p-5 rounded-3xl bg-slate-50 outline-none font-black text-lg focus:border-blue-100 uppercase">
                    <input type="number" id="idade" placeholder="IDADE" class="w-full border-4 border-slate-50 p-5 rounded-3xl bg-slate-50 outline-none font-black text-lg">
                </div>
                <input type="text" id="nome" placeholder="NOME COMPLETO" class="w-full border-4 border-slate-50 p-6 rounded-3xl bg-slate-50 outline-none font-black text-xl uppercase">
                <div class="grid grid-cols-2 gap-4">
                    <select id="sexo" class="border-4 border-slate-50 p-5 rounded-3xl bg-slate-50 outline-none font-black text-lg">
                        <option value="Masculino">‚ôÇ Masculino</option>
                        <option value="Feminino">‚ôÄ Feminino</option>
                    </select>
                    <input type="tel" id="contacto" placeholder="TELEFONE" class="border-4 border-slate-50 p-5 rounded-3xl bg-slate-50 outline-none font-black text-lg">
                </div>
                <div class="p-8 bg-blue-50 rounded-[3rem] border-2 border-blue-100 space-y-6">
                    <select id="tipo" onchange="atualizarRegimes()" class="w-full p-6 rounded-2xl bg-white shadow-lg font-black text-blue-700 text-xl border-none outline-none">
                        <option value="Sens√≠vel">üü¢ TB SENS√çVEL</option>
                        <option value="Resistente">üî¥ TB RESISTENTE</option>
                    </select>
                    <select id="regime" class="w-full p-6 rounded-2xl bg-white shadow-lg font-black text-slate-700 text-lg border-none outline-none"></select>
                </div>
                <div class="space-y-2">
                    <label class="font-black text-xs text-slate-400 ml-4 uppercase">Data de In√≠cio</label>
                    <input type="date" id="dataInicio" class="w-full border-4 border-slate-50 p-6 rounded-3xl bg-slate-50 outline-none font-black text-2xl text-blue-600">
                </div>
            </div>
            <button onclick="salvarPaciente()" class="w-full mt-10 py-7 bg-blue-600 text-white rounded-[2rem] font-black text-2xl uppercase shadow-2xl">CADASTRAR AGORA</button>
        </div>
    </div>

    <script>
        // --- SISTEMA DE VALIDA√á√ÉO ---
        const USER_CORRETO = "tbvanduzi";
        const PASS_CORRETO = "2026";

        function validarAcesso() {
            const user = document.getElementById('userLogin').value.toLowerCase();
            const pass = document.getElementById('passLogin').value;
            const erro = document.getElementById('loginErro');

            if(user === USER_CORRETO && pass === PASS_CORRETO) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                sessionStorage.setItem('logado', 'sim');
                renderizar();
            } else {
                erro.classList.remove('hidden');
                setTimeout(() => erro.classList.add('hidden'), 3000);
            }
        }

        // Verifica se j√° estava logado nesta sess√£o
        if(sessionStorage.getItem('logado') === 'sim') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
        }

        function logout() {
            sessionStorage.removeItem('logado');
            location.reload();
        }

        // --- L√ìGICA DO APP ---
        let pacientes = JSON.parse(localStorage.getItem('tb_pacientes')) || [];

        function atualizarRegimes() {
            const tipo = document.getElementById('tipo').value;
            const rs = document.getElementById('regime');
            rs.innerHTML = tipo === "Sens√≠vel" ? 
                '<option value="2HRZE/4HR">2HRZE/4HR</option><option value="2HRZ+E/4HR">2HRZ+E/4HR</option>' : 
                '<option value="BPaL">üíä BPaL (Resistente)</option>';
        }

        function abrirModal() { document.getElementById('modal').classList.remove('hidden'); atualizarRegimes(); }
        function fecharModal() { document.getElementById('modal').classList.add('hidden'); }

        function salvarPaciente() {
            const p = {
                id: Date.now(),
                nid: document.getElementById('nid').value,
                nome: document.getElementById('nome').value,
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value,
                contacto: document.getElementById('contacto').value,
                tipo: document.getElementById('tipo').value,
                regime: document.getElementById('regime').value,
                dataInicio: document.getElementById('dataInicio').value
            };
            if (!p.nome || !p.dataInicio) return alert("Preencha Nome e Data!");
            pacientes.push(p);
            localStorage.setItem('tb_pacientes', JSON.stringify(pacientes));
            fecharModal(); renderizar(); 
        }

        function renderizar(filtroManual = null) {
            if(sessionStorage.getItem('logado') !== 'sim') return;
            
            const lista = document.getElementById('listaPacientes');
            const painel = document.getElementById('painelAlertas');
            const busca = document.getElementById('inputBusca').value.toLowerCase();
            const hoje = new Date();

            const elegiveisFim = pacientes.filter(p => {
                const dias = Math.floor((hoje - new Date(p.dataInicio)) / 86400000);
                return dias >= 180;
            });

            const controlosHoje = pacientes.filter(p => {
                const dias = Math.floor((hoje - new Date(p.dataInicio)) / 86400000);
                return (p.tipo === "Sens√≠vel" && (dias === 53 || dias === 145));
            });

            painel.innerHTML = '';
            if (elegiveisFim.length > 0) {
                painel.innerHTML += `
                    <div onclick="renderizar('fim')" class="alerta-card bg-orange-500 p-6 rounded-[2rem] text-white shadow-lg cursor-pointer flex justify-between items-center mb-2">
                        <div><p class="font-black text-2xl">${elegiveisFim.length}</p><p class="font-bold text-[10px] uppercase">Eleg√≠veis Fim de Tratamento</p></div>
                        <span class="text-3xl">üèÅ</span>
                    </div>`;
            }
            if (controlosHoje.length > 0) {
                painel.innerHTML += `
                    <div onclick="renderizar('controlo')" class="alerta-card bg-blue-500 p-6 rounded-[2rem] text-white shadow-lg cursor-pointer flex justify-between items-center">
                        <div><p class="font-black text-2xl">${controlosHoje.length}</p><p class="font-bold text-[10px] uppercase">Controlos Hoje</p></div>
                        <span class="text-3xl">üî¨</span>
                    </div>`;
            }

            let filtrados = pacientes;
            if (filtroManual === 'fim') filtrados = elegiveisFim;
            if (filtroManual === 'controlo') filtrados = controlosHoje;
            if (busca) filtrados = filtrados.filter(p => p.nome.toLowerCase().includes(busca) || p.nid.toLowerCase().includes(busca));

            document.getElementById('dashTotal').innerText = pacientes.length;
            document.getElementById('dashSensivel').innerText = pacientes.filter(p => p.tipo === "Sens√≠vel").length;
            document.getElementById('dashResistente').innerText = pacientes.filter(p => p.tipo === "Resistente").length;

            lista.innerHTML = filtrados.reverse().map(p => {
                const dias = Math.floor((hoje - new Date(p.dataInicio)) / 86400000);
                return `
                <div class="paciente-card bg-white shadow-xl border-l-[15px] ${p.tipo === 'Resistente' ? 'border-red-500' : 'border-green-500'} mb-6">
                    <div onclick="this.nextElementSibling.classList.toggle('hidden')" class="p-7 flex justify-between items-center cursor-pointer">
                        <div>
                            <p class="text-[11px] font-black text-slate-400">NID: ${p.nid}</p>
                            <h3 class="font-black text-slate-900 uppercase text-2xl">${p.nome}</h3>
                            <p class="text-xs font-bold text-blue-500 uppercase">${dias} Dias decorridos</p>
                        </div>
                        <span class="text-[11px] font-black uppercase text-blue-700 bg-blue-100 px-4 py-2 rounded-2xl">${p.regime}</span>
                    </div>
                    <div class="hidden p-8 bg-slate-50 border-t-4 border-slate-100 space-y-6">
                        <div class="grid grid-cols-2 gap-4 text-xs font-black text-slate-600">
                            <p>üéÇ ${p.idade} ANOS</p><p>üë§ ${p.sexo}</p>
                            <p class="col-span-2">üìû ${p.contacto || 'SEM TELEFONE'}</p>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-[2rem] text-white text-center">
                            <p class="font-bold text-sm">üìÖ 53¬∫: ${new Date(new Date(p.dataInicio).getTime() + 53*86400000).toLocaleDateString()}</p>
                            <p class="font-bold text-sm">üìÖ 145¬∫: ${new Date(new Date(p.dataInicio).getTime() + 145*86400000).toLocaleDateString()}</p>
                        </div>
                        <button onclick="remover(${p.id})" class="w-full text-red-400 font-black text-xs pt-4 uppercase">Excluir</button>
                    </div>
                </div>`;
            }).join('');
        }

        function remover(id) { if(confirm("Apagar?")) { pacientes = pacientes.filter(p => p.id !== id); localStorage.setItem('tb_pacientes', JSON.stringify(pacientes)); renderizar(); } }
        function exportarDados() { const blob = new Blob([JSON.stringify(pacientes)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "backup_tb.json"; a.click(); }
        function importarDados(event) { const reader = new FileReader(); reader.onload = e => { pacientes = JSON.parse(e.target.result); localStorage.setItem('tb_pacientes', JSON.stringify(pacientes)); renderizar(); }; reader.readAsText(event.target.files[0]); }

        renderizar();
    </script>
</body>
</html>
