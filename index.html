<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>TB-CONTROL</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-scroll { max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-10">

    <header class="p-6 bg-white border-b sticky top-0 z-10 shadow-sm">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="font-bold text-xl tracking-tight text-blue-700">TB-CONTROL</h1>
                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Gestão Clínica Especializada</p>
            </div>
            <div class="text-right">
                <p id="totalAtivos" class="text-2xl font-black text-slate-800 leading-none">0</p>
                <p class="text-[9px] text-gray-400 uppercase font-bold">Pacientes</p>
            </div>
        </div>
    </header>

    <main class="p-4 space-y-4">
        <button onclick="abrirModal()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            ADICIONAR NOVO PACIENTE
        </button>

        <div id="listaPacientes" class="space-y-3">
            </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-20">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl modal-scroll">
            <h2 class="font-bold text-xl mb-4 text-slate-800 border-b pb-2">Novo Registro</h2>
            
            <div class="space-y-3">
                <input type="text" id="nid" placeholder="NID" class="w-full border p-3 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="nome" placeholder="Nome Completo" class="w-full border p-3 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500">
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="idade" placeholder="Idade" class="border p-3 rounded-xl bg-slate-50 outline-none">
                    <select id="sexo" class="border p-3 rounded-xl bg-slate-50 outline-none">
                        <option value="">Sexo</option>
                        <option value="Masculino">Masc</option>
                        <option value="Feminino">Fem</option>
                    </select>
                </div>

                <input type="tel" id="contacto" placeholder="Contacto" class="w-full border p-3 rounded-xl bg-slate-50 outline-none">
                
                <label class="block text-xs font-bold text-gray-400 ml-1">CARACTERIZAÇÃO</label>
                <select id="caracterizacao" class="w-full border p-3 rounded-xl bg-slate-50 outline-none">
                    <option value="Pulmonar">Pulmonar</option>
                    <option value="Extra-Pulmonar">Extra-Pulmonar</option>
                </select>

                <div class="grid grid-cols-2 gap-2">
                    <select id="diagnostico" class="border p-3 rounded-xl bg-slate-50 outline-none">
                        <option value="Bacteriológico">Bacteriológico</option>
                        <option value="Clínico">Clínico</option>
                    </select>
                    <select id="tipo" class="border p-3 rounded-xl bg-slate-50 outline-none bg-yellow-50 font-bold">
                        <option value="Sensível">Sensível</option>
                        <option value="Resistente">Resistente</option>
                    </select>
                </div>
                
                <label class="block text-xs font-bold text-gray-400 ml-1">INÍCIO DO TRATAMENTO</label>
                <input type="date" id="dataInicio" class="w-full border p-3 rounded-xl bg-slate-50 outline-none">
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="fecharModal()" class="flex-1 py-3 text-gray-400 font-bold">CANCELAR</button>
                <button onclick="salvarPaciente()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md">SALVAR</button>
            </div>
        </div>
    </div>

    <script>
        let pacientes = JSON.parse(localStorage.getItem('pacientes')) || [];

        function abrirModal() { document.getElementById('modal').classList.remove('hidden'); }
        function fecharModal() { document.getElementById('modal').classList.add('hidden'); }

        function formatarData(dataStr) {
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR');
        }

        function calcularControlos(dataInicio, tipo) {
            const inicio = new Date(dataInicio);
            let agenda = [];
            
            if (tipo === "Sensível") {
                let d53 = new Date(inicio); d53.setDate(inicio.getDate() + 53);
                let d145 = new Date(inicio); d145.setDate(inicio.getDate() + 145);
                agenda.push(`53º dia: ${formatarData(d53)}`, `145º dia: ${formatarData(d145)}`);
            } else {
                agenda.push("Controlo Mensal Recomendo");
            }
            return agenda;
        }

        function salvarPaciente() {
            const p = {
                id: Date.now(),
                nid: document.getElementById('nid').value,
                nome: document.getElementById('nome').value,
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value,
                contacto: document.getElementById('contacto').value,
                caracterizacao: document.getElementById('caracterizacao').value,
                diagnostico: document.getElementById('diagnostico').value,
                tipo: document.getElementById('tipo').value,
                dataInicio: document.getElementById('dataInicio').value
            };

            if (!p.nome || !p.dataInicio) return alert("Preencha Nome e Data de Início!");

            pacientes.push(p);
            localStorage.setItem('pacientes', JSON.stringify(pacientes));
            fecharModal();
            renderizarPacientes();
            limparCampos();
        }

        function limparCampos() {
            document.querySelectorAll('input').forEach(i => i.value = '');
        }

        function removerPaciente(id) {
            if(confirm("Deseja apagar este registro?")) {
                pacientes = pacientes.filter(p => p.id !== id);
                localStorage.setItem('pacientes', JSON.stringify(pacientes));
                renderizarPacientes();
            }
        }

        function renderizarPacientes() {
            const lista = document.getElementById('listaPacientes');
            document.getElementById('totalAtivos').innerText = pacientes.length;
            
            if (pacientes.length === 0) {
                lista.innerHTML = '<div class="text-center py-20 opacity-30"><p class="font-bold">NENHUM PACIENTE</p></div>';
                return;
            }

            lista.innerHTML = pacientes.map(p => {
                const controlos = calcularControlos(p.dataInicio, p.tipo);
                return `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black bg-slate-100 px-2 py-1 rounded text-slate-500 uppercase">NID: ${p.nid}</span>
                        <button onclick="removerPaciente(${p.id})" class="text-red-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 uppercase">${p.nome}</h3>
                    <div class="grid grid-cols-2 text-xs text-slate-500 mt-1 gap-y-1">
                        <p><b>Idade:</b> ${p.idade} | ${p.sexo}</p>
                        <p><b>Diagnóstico:</b> ${p.diagnostico}</p>
                        <p><b>Forma:</b> ${p.caracterizacao}</p>
                        <p><b>Tipo:</b> <span class="${p.tipo === 'Resistente' ? 'text-red-600 font-bold' : 'text-green-600 font-bold'}">${p.tipo}</span></p>
                    </div>
                    
                    <div class="mt-3 p-3 bg-blue-50 rounded-xl border border-blue-100">
                        <p class="text-[10px] font-bold text-blue-400 uppercase mb-1">Próximos Controlos:</p>
                        ${controlos.map(c => `<p class="text-xs font-bold text-blue-800 tracking-tight">${c}</p>`).join('')}
                    </div>
                </div>
                `;
            }).join('');
        }

        renderizarPacientes();
    </script>
</body>
</html>
