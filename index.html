<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e293b">
    <title>TB-CONTROL VANDUZI PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f1f5f9; }
        .paciente-card { transition: all 0.2s; border-radius: 2.5rem; background: white; box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); }
        .modal-scroll { max-height: 90vh; overflow-y: auto; border-radius: 3.5rem; }
        .btn-blue { background-color: #0ea5e9; color: white; border-radius: 2rem; font-weight: 900; }
        .alerta-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #appContent { display: none; }
        html { font-size: 19px; }
    </style>
</head>
<body class="pb-40">

    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-lg rounded-[4rem] p-12 shadow-2xl text-center border-t-[20px] border-sky-500">
            <div class="mb-10 text-center">
                <div class="bg-sky-100 w-28 h-28 rounded-full flex items-center justify-center mx-auto mb-6 text-6xl">üîê</div>
                <h2 class="font-black text-4xl text-slate-800 uppercase italic">TB-CONTROL</h2>
                <p class="font-bold text-slate-400 mt-2 uppercase tracking-widest text-sm">Unidade Sanit√°ria Vanduzi</p>
            </div>
            <div class="space-y-6">
                <input type="text" id="userLogin" placeholder="UTILIZADOR" class="w-full border-4 border-slate-100 p-7 rounded-3xl bg-slate-50 outline-none font-black text-2xl uppercase focus:border-sky-300">
                <input type="password" id="passLogin" placeholder="SENHA" class="w-full border-4 border-slate-100 p-7 rounded-3xl bg-slate-50 outline-none font-black text-2xl focus:border-sky-300">
                <button onclick="validarAcesso()" class="w-full py-8 btn-blue text-3xl uppercase shadow-xl active:scale-95 transition-all">ENTRAR</button>
            </div>
        </div>
    </div>

    <div id="appContent">
        <header class="bg-slate-900 p-10 text-white sticky top-0 z-10 shadow-2xl rounded-b-[4rem]">
            <div class="flex justify-between items-center mb-10">
                <h1 class="font-black text-4xl italic tracking-tighter">TB-CONTROL <span class="text-sky-400 font-light text-xl block not-italic uppercase tracking-widest">Vanduzi 2026</span></h1>
                <div class="flex gap-4">
                    <button onclick="exportarDados()" class="bg-slate-800 p-5 rounded-3xl text-3xl">üì§</button>
                    <button onclick="logout()" class="bg-red-900/40 p-5 rounded-3xl text-3xl border border-red-500/30">üö™</button>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-6">
                <div class="bg-white/10 p-6 rounded-[2.5rem] border-b-[10px] border-sky-500 text-center">
                    <p class="text-xs font-black text-sky-300 uppercase mb-2">Total</p>
                    <p id="dashTotal" class="text-5xl font-black text-white">0</p>
                </div>
                <div class="bg-white/10 p-6 rounded-[2.5rem] border-b-[10px] border-green-500 text-center">
                    <p class="text-xs font-black text-green-300 uppercase mb-2">Ativos</p>
                    <p id="dashAtivos" class="text-5xl font-black text-white">0</p>
                </div>
                <div class="bg-white/10 p-6 rounded-[2.5rem] border-b-[10px] border-red-500 text-center">
                    <p class="text-xs font-black text-red-300 uppercase mb-2">Resist.</p>
                    <p id="dashResistente" class="text-5xl font-black text-white">0</p>
                </div>
            </div>
        </header>

        <main class="p-8">
            <div id="painelAlertas" class="space-y-6 mb-12"></div>

            <div class="relative mb-12">
                <input type="text" id="inputBusca" onkeyup="renderizar()" placeholder="NID OU NOME DO PACIENTE..." 
                    class="w-full bg-white border-4 border-white p-9 pl-24 rounded-[3.5rem] shadow-2xl outline-none focus:border-sky-500 text-3xl font-black">
                <span class="absolute left-9 top-9 text-5xl">üîç</span>
            </div>

            <div id="listaPacientes" class="space-y-10"></div>
        </main>

        <button onclick="abrirModal()" class="fixed bottom-12 right-12 w-28 h-28 bg-sky-500 text-white rounded-full shadow-2xl flex items-center justify-center text-7xl font-light active:scale-90 transition-all z-20">
            +
        </button>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-2xl p-12 shadow-2xl modal-scroll border-t-[20px] border-sky-500">
            <h2 id="modalTitulo" class="font-black text-4xl text-slate-800 mb-10 uppercase italic">Novo Cadastro</h2>
            <div class="space-y-8">
                <input type="text" id="nome" placeholder="NOME COMPLETO" class="w-full border-4 border-slate-50 p-8 rounded-[2.5rem] bg-slate-50 font-black text-2xl uppercase">
                <div class="grid grid-cols-2 gap-6">
                    <input type="text" id="nid" placeholder="NID" class="w-full border-4 border-slate-50 p-8 rounded-[2.5rem] bg-slate-50 font-black text-2xl uppercase">
                    <input type="number" id="idade" placeholder="IDADE" class="w-full border-4 border-slate-50 p-8 rounded-[2.5rem] bg-slate-50 font-black text-2xl">
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <select id="diagnostico" class="border-4 border-slate-50 p-8 rounded-[2.5rem] bg-slate-100 font-black text-xl">
                        <option value="">FORMA DX</option>
                        <option value="Baciloscopia +">Baciloscopia +</option>
                        <option value="GeneXpert">GeneXpert</option>
                        <option value="Cl√≠nico">Cl√≠nico</option>
                        <option value="Extra-Pulmonar">Extra-Pulmonar</option>
                    </select>
                    <select id="estado" class="border-4 border-slate-50 p-8 rounded-[2.5rem] bg-sky-50 font-black text-xl text-sky-700">
                        <option value="Em Tratamento">üîÑ EM TRATAMENTO</option>
                        <option value="Curado">‚úÖ CURADO</option>
                        <option value="Abandono">‚ö†Ô∏è ABANDONO</option>
                        <option value="√ìbito">‚ö∞Ô∏è √ìBITO</option>
                        <option value="Transferido">‚úàÔ∏è TRANSFERIDO</option>
                    </select>
                </div>
                <div class="p-10 bg-sky-50 rounded-[3.5rem] border-4 border-sky-100 space-y-8">
                    <select id="tipo" onchange="atualizarRegimes()" class="w-full p-8 rounded-[2rem] font-black text-3xl text-sky-800">
                        <option value="Sens√≠vel">üü¢ TB SENS√çVEL</option>
                        <option value="Resistente">üî¥ TB RESISTENTE</option>
                    </select>
                    <select id="regime" class="w-full p-8 rounded-[2rem] font-black text-2xl text-slate-600"></select>
                </div>
                <div class="px-6">
                    <label class="font-black text-xl text-slate-400 uppercase italic">Data de In√≠cio</label>
                    <input type="date" id="dataInicio" class="w-full border-b-8 border-sky-500 p-6 font-black text-5xl text-sky-600 outline-none mt-2">
                </div>
            </div>
            <button onclick="salvarPaciente()" class="w-full mt-14 py-10 btn-blue text-4xl uppercase shadow-2xl">GRAVAR DADOS</button>
        </div>
    </div>

    <script>
        let pacientes = JSON.parse(localStorage.getItem('tb_pacientes')) || [];
        let editandoId = null;

        function validarAcesso() {
            if(document.getElementById('userLogin').value.toLowerCase() === "tbvanduzi" && document.getElementById('passLogin').value === "2026") {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                sessionStorage.setItem('logado', 'sim');
                renderizar();
            }
        }
        if(sessionStorage.getItem('logado') === 'sim') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
        }
        function logout() { sessionStorage.removeItem('logado'); location.reload(); }

        function atualizarRegimes() {
            const tipo = document.getElementById('tipo').value;
            const rs = document.getElementById('regime');
            rs.innerHTML = tipo === "Sens√≠vel" ? 
                '<option value="2HRZE/4HR">2HRZE/4HR</option>' : '<option value="BPaL">BPaL</option>';
        }

        function abrirModal(id = null) {
            editandoId = id;
            if(id) {
                const p = pacientes.find(p => p.id === id);
                document.getElementById('nid').value = p.nid;
                document.getElementById('nome').value = p.nome;
                document.getElementById('idade').value = p.idade;
                document.getElementById('diagnostico').value = p.diagnostico || "";
                document.getElementById('estado').value = p.estado || "Em Tratamento";
                document.getElementById('tipo').value = p.tipo;
                document.getElementById('dataInicio').value = p.dataInicio;
                document.getElementById('modalTitulo').innerText = "Atualizar Paciente";
            } else {
                document.getElementById('modalTitulo').innerText = "Novo Cadastro";
                document.querySelectorAll('#modal input').forEach(i => i.value = '');
            }
            document.getElementById('modal').classList.remove('hidden');
            atualizarRegimes();
        }

        function fecharModal() { document.getElementById('modal').classList.add('hidden'); }

        function salvarPaciente() {
            const p = {
                id: editandoId || Date.now(),
                nid: document.getElementById('nid').value,
                nome: document.getElementById('nome').value,
                idade: document.getElementById('idade').value,
                diagnostico: document.getElementById('diagnostico').value,
                estado: document.getElementById('estado').value,
                tipo: document.getElementById('tipo').value,
                regime: document.getElementById('regime').value,
                dataInicio: document.getElementById('dataInicio').value
            };
            if (!p.nome || !p.dataInicio) return alert("Erro: Nome e Data obrigat√≥rios!");
            if(editandoId) {
                const idx = pacientes.findIndex(item => item.id === editandoId);
                pacientes[idx] = p;
            } else {
                pacientes.push(p);
            }
            localStorage.setItem('tb_pacientes', JSON.stringify(pacientes));
            fecharModal(); renderizar();
        }

        function renderizar(filtroAlerta = null) {
            if(sessionStorage.getItem('logado') !== 'sim') return;
            const lista = document.getElementById('listaPacientes');
            const painel = document.getElementById('painelAlertas');
            const busca = document.getElementById('inputBusca').value.toLowerCase();
            const hoje = new Date();

            // L√≥gica de Alerta de Controlos
            const controlosHoje = pacientes.filter(p => {
                if(p.estado !== "Em Tratamento") return false;
                const dias = Math.floor((hoje - new Date(p.dataInicio)) / 86400000);
                if(p.tipo === "Sens√≠vel") {
                    return (dias === 53 || dias === 145);
                } else {
                    // TB Resistente: BK Mensal (30, 60, 90, 120, 150, 180 dias)
                    return [30, 60, 90, 120, 150, 180].includes(dias);
                }
            });

            const elegiveisFim = pacientes.filter(p => {
                const dias = Math.floor((hoje - new Date(p.dataInicio)) / 86400000);
                return p.estado === "Em Tratamento" && dias >= 180;
            });

            painel.innerHTML = '';
            if(elegiveisFim.length > 0) {
                painel.innerHTML += `<div onclick="renderizar('fim')" class="alerta-pulse bg-orange-600 p-10 rounded-[3rem] text-white shadow-2xl flex justify-between items-center cursor-pointer"><div><p class="font-black text-6xl">${elegiveisFim.length}</p><p class="font-black text-xl uppercase">Fim de Tratamento</p></div><span class="text-7xl">üèÅ</span></div>`;
            }
            if(controlosHoje.length > 0) {
                painel.innerHTML += `<div onclick="renderizar('controlo')" class="bg-sky-600 p-10 rounded-[3rem] text-white shadow-2xl flex justify-between items-center cursor-pointer border-l-[20px] border-white/20"><div><p class="font-black text-6xl">${controlosHoje.length}</p><p class="font-black text-xl uppercase">Controlos de BK Hoje</p></div><span class="text-7xl">üî¨</span></div>`;
            }

            let filtrados = pacientes;
            if(filtroAlerta === 'fim') filtrados = elegiveisFim;
            if(filtroAlerta === 'controlo') filtrados = controlosHoje;
            if(busca) filtrados = filtrados.filter(p => p.nome.toLowerCase().includes(busca) || p.nid.toLowerCase().includes(busca));

            document.getElementById('dashTotal').innerText = pacientes.length;
            document.getElementById('dashAtivos').innerText = pacientes.filter(p => p.estado === "Em Tratamento").length;
            document.getElementById('dashResistente').innerText = pacientes.filter(p => p.tipo === "Resistente").length;

            lista.innerHTML = filtrados.reverse().map(p => {
                const dInicio = new Date(p.dataInicio);
                const dias = Math.floor((hoje - dInicio) / 86400000);
                
                // C√°lculo de datas de controlo
                let htmlControlos = "";
                if(p.tipo === "Sens√≠vel") {
                    htmlControlos = `
                        <p>üî¨ 2¬∫ M√™s (53¬∫ dia): ${new Date(dInicio.getTime() + 53*86400000).toLocaleDateString()}</p>
                        <p>üî¨ 5¬∫ M√™s (145¬∫ dia): ${new Date(dInicio.getTime() + 145*86400000).toLocaleDateString()}</p>`;
                } else {
                    htmlControlos = `<p class="font-black text-sky-600 mb-2">üìÖ CONTROLO MENSAL (BK):</p><div class="grid grid-cols-2 gap-2 text-[15px]">`;
                    for(let m=1; m<=6; m++) {
                        htmlControlos += `<p>${m}¬∫ M√™s: ${new Date(dInicio.getTime() + (m*30)*86400000).toLocaleDateString()}</p>`;
                    }
                    htmlControlos += `</div>`;
                }

                const cores = {"Em Tratamento": "bg-sky-100 text-sky-700", "Curado": "bg-green-100 text-green-700", "Abandono": "bg-yellow-100 text-yellow-700", "√ìbito": "bg-red-100 text-red-700", "Transferido": "bg-slate-200 text-slate-700"};

                return `
                <div class="paciente-card border-l-[25px] ${p.tipo === 'Resistente' ? 'border-red-600' : 'border-green-600'}">
                    <div onclick="this.nextElementSibling.classList.toggle('hidden')" class="p-10 cursor-pointer">
                        <div class="flex justify-between items-start mb-4">
                            <p class="font-black text-slate-400 text-xl tracking-widest uppercase">NID: ${p.nid}</p>
                            <span class="px-6 py-2 rounded-3xl font-black text-lg uppercase ${cores[p.estado]}">${p.estado}</span>
                        </div>
                        <h3 class="font-black text-slate-900 text-4xl uppercase leading-tight mb-4">${p.nome}</h3>
                        <div class="flex flex-wrap gap-4">
                            <span class="bg-slate-100 px-5 py-3 rounded-2xl text-lg font-black text-slate-500 uppercase italic">ü©∫ DX: ${p.diagnostico || 'S/ DX'}</span>
                            <span class="bg-sky-50 px-5 py-3 rounded-2xl text-lg font-black text-sky-600 uppercase italic">üìÖ ${dias} DIAS</span>
                        </div>
                    </div>
                    <div class="hidden p-10 bg-slate-50 border-t-8 border-slate-100 space-y-8 rounded-b-[2.5rem]">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-2 border-slate-100 font-bold text-slate-700">
                            ${htmlControlos}
                        </div>
                        <div class="flex gap-4">
                            <button onclick="abrirModal(${p.id})" class="flex-1 bg-sky-500 text-white py-8 rounded-[2rem] font-black text-2xl uppercase">ATUALIZAR / EDITAR</button>
                            <button onclick="remover(${p.id})" class="px-6 text-red-300 font-bold uppercase text-xs">Excluir</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function remover(id) { if(confirm("Eliminar permanentemente?")) { pacientes = pacientes.filter(p => p.id !== id); localStorage.setItem('tb_pacientes', JSON.stringify(pacientes)); renderizar(); } }
        function exportarDados() { const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(pacientes)); const a = document.createElement('a'); a.href = data; a.download = "tb_vanduzi_2026.json"; a.click(); }
        
        renderizar();
    </script>
</body>
</html>
