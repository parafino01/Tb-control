<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TB-CONTROL POCKET</title>
    <style>
        :root {
            --primary: #004d40;
            --accent: #ff6b00;
            --bg: #e0e5ec;
            --shadow: 5px 5px 10px #b8b9be, -5px -5px 10px #ffffff;
        }

        /* Reset para evitar quebras de ecr√£ */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: sans-serif; margin: 0; background: var(--bg); 
            color: #333; overflow-x: hidden; width: 100vw;
        }
        
        header { 
            background: var(--primary); color: white; padding: 12px 15px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 2000; height: 60px;
        }

        .dashboard { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; 
        }
        .card {
            background: var(--bg); border-radius: 15px; padding: 12px; text-align: center;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.4);
        }
        .card h3 { margin: 0; font-size: 9px; color: #7f8c8d; text-transform: uppercase; }
        .card p { margin: 4px 0 0 0; font-size: 20px; font-weight: 900; color: var(--primary); }

        .lista-container { padding: 5px 0 100px 0; }

        .paciente-item { 
            background: var(--bg); margin: 10px; padding: 15px; border-radius: 15px; 
            box-shadow: var(--shadow); border-left: 6px solid var(--primary);
        }

        /* BOT√ÉO NOVO PACIENTE - FIXO NO CANTO */
        .fab {
            position: fixed; bottom: 25px; right: 20px; width: 65px; height: 65px;
            background: var(--accent); border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 3000;
            border: 3px solid white; cursor: pointer;
        }

        /* MODAL COM SCROLL INTERNO */
        .modal { 
            display: none; position: fixed; z-index: 4000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
        }
        .modal-content { 
            background: var(--bg); margin: 5vh auto; padding: 20px; 
            width: 90%; max-height: 90vh; border-radius: 20px; 
            overflow-y: auto; /* Permite scroll no formul√°rio */
            box-shadow: var(--shadow);
        }
        
        .form-section { margin-bottom: 15px; }
        input, select { 
            width: 100%; padding: 12px; border: none; border-radius: 10px; 
            background: var(--bg); box-shadow: inset 3px 3px 6px #b8b9be, inset -3px -3px 6px #ffffff;
            font-size: 14px; margin-top: 5px; margin-bottom: 10px;
        }
        
        .btn-main { 
            width: 100%; padding: 16px; background: var(--primary); 
            color: white; border: none; border-radius: 12px; 
            font-weight: 900; font-size: 16px;
        }

        .tag { font-size: 9px; padding: 3px 8px; border-radius: 5px; color: white; font-weight: bold; margin-right: 4px; }
        .search-icon { font-size: 24px; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 900;">TB-CONTROL</div>
    <div style="display: flex; align-items: center; gap: 10px;">
        <input type="text" id="busca" style="display:none; width: 120px; padding: 5px; border-radius: 10px;" placeholder="Procurar..." onkeyup="renderizar()">
        <span class="search-icon" onclick="toggleBusca()">üîç</span>
    </div>
</header>

<div class="dashboard">
    <div class="card"><h3>Ativos</h3><p id="dash-ativos">0</p></div>
    <div class="card"><h3>Curados</h3><p id="dash-curados">0</p></div>
    <div class="card"><h3>Inativos</h3><p id="dash-inativos">0</p></div>
    <div class="card"><h3>HIV+</h3><p id="dash-hiv">0</p></div>
</div>

<div id="lista" class="lista-container"></div>

<div class="fab" id="btnNovo" onclick="abrirModalRegisto()">+</div>

<div id="modalRegisto" class="modal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0; color:var(--primary); text-align:center;">Nova Inscri√ß√£o</h3>
        
        <label style="font-size: 11px; font-weight: bold;">IDENTIFICA√á√ÉO</label>
        <input type="text" id="nid" placeholder="NID">
        <input type="text" id="nome" placeholder="Nome Completo">
        <input type="text" id="endereco" placeholder="Morada/Contacto">
        
        <div style="display:flex; gap:10px;">
            <input type="number" id="idade" placeholder="Idade">
            <select id="sexo"><option value="M">Masc</option><option value="F">Fem</option></select>
        </div>

        <label style="font-size: 11px; font-weight: bold;">CL√çNICA</label>
        <input type="number" id="peso" placeholder="Peso (kg)">
        <select id="forma"><option value="Pulmonar">Pulmonar</option><option value="Extra-Pulmonar">Extra-Pulmonar</option></select>
        <select id="diagnostico"><option value="GeneXpert">GeneXpert</option><option value="Bacilos">Bacilos</option><option value="Cl√≠nico">Cl√≠nico</option></select>
        <select id="tipo_tb"><option value="Sens√≠vel">TB Sens√≠vel</option><option value="Resistente">TB Resistente</option></select>
        
        <label style="font-size: 11px; font-weight: bold;">HIV & CONTACTOS</label>
        <select id="status_hiv" onchange="document.getElementById('divTARV').style.display = (this.value=='Positivo'?'block':'none')">
            <option value="Negativo">HIV Negativo</option>
            <option value="Positivo">HIV Positivo</option>
        </select>
        <div id="divTARV" style="display:none;"><select id="tarv"><option value="Sim">Em TARV</option><option value="N√£o">N√£o TARV</option></select></div>
        <input type="number" id="contactos" placeholder="Contactos Rastreados">
        
        <label style="font-size: 11px; font-weight: bold;">IN√çCIO DO TRATAMENTO</label>
        <input type="date" id="data_inicio">

        <button class="btn-main" onclick="salvarPaciente()">GRAVAR PACIENTE</button>
        <button onclick="fecharModalRegisto()" style="width:100%; border:none; background:none; color:gray; margin-top:15px;">Fechar</button>
    </div>
</div>

<div id="modalStatus" class="modal">
    <div class="modal-content">
        <h3 id="nomeModal" style="text-align:center;"></h3>
        <select id="novoEstado">
            <option value="Em tratamento">Em tratamento</option>
            <option value="Curado">Curado</option>
            <option value="Perda de seguimento">Perda de seguimento</option>
            <option value="√ìbito">√ìbito</option>
            <option value="Transferido">Transferido</option>
        </select>
        <button class="btn-main" onclick="confirmarStatus()">ATUALIZAR ESTADO</button>
        <button onclick="eliminarPaciente()" style="width:100%; color:red; border:none; background:none; margin-top:20px;">Apagar Permanente</button>
        <button onclick="fecharModalStatus()" style="width:100%; border:none; background:none; margin-top:10px;">Sair</button>
    </div>
</div>

<script>
    let pacientes = JSON.parse(localStorage.getItem('tb_ultra_v9')) || [];
    let idSelecionado = null;

    function toggleBusca() {
        const b = document.getElementById('busca');
        b.style.display = b.style.display === 'none' ? 'block' : 'none';
    }

    function abrirModalRegisto() { document.getElementById('modalRegisto').style.display = "block"; }
    function fecharModalRegisto() { document.getElementById('modalRegisto').style.display = "none"; }
    
    function abrirModalStatus(id) { 
        idSelecionado = id; 
        const p = pacientes.find(x => x.id === id);
        document.getElementById('nomeModal').innerText = p.nome;
        document.getElementById('novoEstado').value = p.estado;
        document.getElementById('modalStatus').style.display = "block"; 
    }
    function fecharModalStatus() { document.getElementById('modalStatus').style.display = "none"; }

    function salvarPaciente() {
        const p = {
            id: Date.now(),
            nid: document.getElementById('nid').value,
            nome: document.getElementById('nome').value,
            endereco: document.getElementById('endereco').value,
            peso: document.getElementById('peso').value,
            tipo: document.getElementById('tipo_tb').value,
            hiv: document.getElementById('status_hiv').value,
            inicio: document.getElementById('data_inicio').value,
            estado: "Em tratamento"
        };
        if(!p.nid || !p.nome || !p.inicio) return alert("Preencha NID, Nome e Data!");
        pacientes.push(p);
        localStorage.setItem('tb_ultra_v9', JSON.stringify(pacientes));
        renderizar();
        fecharModalRegisto();
    }

    function confirmarStatus() {
        const p = pacientes.find(x => x.id === idSelecionado);
        p.estado = document.getElementById('novoEstado').value;
        localStorage.setItem('tb_ultra_v9', JSON.stringify(pacientes));
        renderizar();
        fecharModalStatus();
    }

    function eliminarPaciente() {
        if(confirm("Eliminar registo?")) {
            pacientes = pacientes.filter(x => x.id !== idSelecionado);
            localStorage.setItem('tb_ultra_v9', JSON.stringify(pacientes));
            renderizar();
            fecharModalStatus();
        }
    }

    function renderizar() {
        const lista = document.getElementById('lista');
        const busca = document.getElementById('busca').value.toLowerCase();
        lista.innerHTML = "";
        
        let cAtivos = 0, cCurados = 0, cInativos = 0, cHiv = 0;

        pacientes.filter(p => p.nome.toLowerCase().includes(busca) || p.nid.toLowerCase().includes(busca)).forEach(p => {
            if(p.estado === "Em tratamento") { cAtivos++; if(p.hiv === "Positivo") cHiv++; }
            else if(p.estado === "Curado") { cCurados++; }
            else { cInativos++; }

            lista.innerHTML += `
                <div class="paciente-item" onclick="abrirModalStatus(${p.id})">
                    <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:bold; color:gray;">
                        <span>NID: ${p.nid}</span>
                        <span class="tag" style="background:#34495e">${p.estado}</span>
                    </div>
                    <div style="font-size:18px; color:var(--primary); font-weight:bold; margin:5px 0;">${p.nome}</div>
                    <div style="display:flex; gap:5px;">
                        <span class="tag" style="background:#27ae60">${p.tipo}</span>
                        <span class="tag" style="background:#9b59b6">HIV: ${p.hiv}</span>
                    </div>
                </div>
            `;
        });
        document.getElementById('dash-ativos').innerText = cAtivos;
        document.getElementById('dash-curados').innerText = cCurados;
        document.getElementById('dash-inativos').innerText = cInativos;
        document.getElementById('dash-hiv').innerText = cHiv;
    }
    renderizar();
</script>
</body>
</html>
